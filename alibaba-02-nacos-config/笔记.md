#### 整合Nacos作为配置中心
`1、引入相关依赖`
```xml
<dependency>
	<groupId>com.alibaba.cloud</groupId>
	<artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```
注意：和Nacos作为服务注册中心时引入的依赖不相同。

如果是在2020.0.0版本之后，还需要添加下面这个依赖，否则系统启动不会读取bootstrap配置文件导致启动报错，这是一个坑。
```xml
<dependency>
     <groupId>org.springframework.cloud</groupId>
     <artifactId>spring-cloud-starter-bootstrap</artifactId>
</dependency>
```

`2、进行相关配置`
具体配置根据项目不同而异，下面是一些基本和常用配置。
新建bootstrap.properties配置文件，这个配置文件主要存放nacos相关的配置，如下：
```properties
#从指定的命名空间拉取配置
spring.cloud.nacos.config.namespace: 15c3bf2f-4692-479a-83a7-de3fccd6358e
#Nacos地址
spring.cloud.nacos.server-addr=localhost:8848
#文件后缀名
spring.cloud.nacos.config.file-extension=properties
# 服务名称
spring.application.name=nacos-config
spring.profiles.active=9201
```


`3、Nacos控制台新建配置`
打开Nacos控制台，添加配置
![7c6bb5030928a3725c5bdedd70fb51a5.png](evernotecid://856601FE-F606-47C9-A312-C117E55C924E/appyinxiangcom/17968037/ENResource/p1285)

![41a10aa504a239638432bd5ba06f47eb.png](evernotecid://856601FE-F606-47C9-A312-C117E55C924E/appyinxiangcom/17968037/ENResource/p1286)

>namespace区分环境：开发环境、测试环境、预发布环境、⽣产环境。主配置应当在dataId上要区分，同时最好还要有group的区分

>group区分不同应⽤：同⼀个环境内，不同应⽤的配置，通过group来区分。


在 Nacos Spring Cloud 中，dataId 的完整格式如下：
```
 ${prefix}-${spring.profiles.active}.${file-extension} 
```
prefix：默认为 spring.application.name 的值，也可以通过配置项 spring.cloud.nacos.config.prefix来配置

spring.profiles.active：即为当前环境对应的 profile。 注意：当 spring.profiles.active 为空时，对应的连接符 - 也将不存在，dataId 的拼接格式变

`4、在代码中获取配置中心的配置`
在代码中需要配置的地方获取配置，直接使用@Value注解即可获取，但是这种方式有个缺陷就是：改nacos中的配置后，需要重启微服务才能获取更新后的配置。后面会介绍更优的获取方式。
```java
@RestController
public class NicosConfigController {

    @Value("${k}")
    private String k;

    @Value("${common_k}")
    private String common_k;


    @RequestMapping("config")
    public Map<String, String> getConfig(){
        Map<String, String> stringStringMap = new HashMap<>();

        stringStringMap.put("k", k);
        stringStringMap.put("common_k", common_k);

        return stringStringMap;
    }
}
```
![14efb15d4a22c29e2867b6a8ba8d62f1.png](evernotecid://856601FE-F606-47C9-A312-C117E55C924E/appyinxiangcom/17968037/ENResource/p1289)
从上面示例也可以看出：如果配置中心和当前应用的配置文件中都配置了相同的项，优先使用配置中心的配置。

`需要注意的是`：Nacos客户端（也就是使用了Nacos的微服务）会将Nacos服务端的配置下载到客户端本地（若服务端配置有变更，会自动将变更后的下载到客户端本地），作为配置的临时暂存。

这个目录的位置是：$HOME/nacos/config/fixed-NacosServerIP_nacos/，
其中$HOME为客户端应用启动用户所在的HOME路径。

例如。在我的电脑上如下目录就可以看到上面在Nacos控制台创建的nacos-config-9201.properties配置文件。
![6856e4ce5b1dc8dbf2bd3f27a951c5a1.png](evernotecid://856601FE-F606-47C9-A312-C117E55C924E/appyinxiangcom/17968037/ENResource/p1292)

####  配置热更新
我们最终的目的，是修改nacos中的配置后，微服务中无需重启即可让配置生效，也就是配置热更新。要实现配置热更新，方法有多种，这里介绍其中d 两种方式：

##### 方式一
在@Value注入的变量所在类上添加注解@RefreshScope：
```java
@RestController
@RefreshScope
public class NicosConfigController {

    @Value("${k}")
    private String k;

    @Value("${common_k}")
    private String common_k;
    .....................
    .....................
    .....................
}
```
##### 方式二
使用@ConfigurationProperties注解,需要注意的是这种方式需要实现setter方法。
```java
@ConfigurationProperties
@RestController
public class NicosConfigController {

    private String k;

    private String common_k;

    public void setK(String k) {
        this.k = k;
    }

    public void setCommon_k(String common_k) {
        this.common_k = common_k;
    }
    .....................
    .....................
    .....................
}
```

#### 共享配置
在一个微服务系统里，有些配置需要被许多微服务共同使用的，比如MySql的配置。
如果每个微服务都在自己的配置里单独维护同样的MySql配置，当MySql配置发生变更时，那么每个服务都要改一次，繁琐且容易出错。


为了解决这个问题，Nacos给我们提供了共享配置的特性。使用共享配置方式如下：
`1、`Nacos控制台新建配置
在Nacos控制台新建配置文件common-dev.properties，当然这个配置文件名是可以自己定义的。
![100cebdd6af5ab9602ece0ed9d41381e.png](evernotecid://856601FE-F606-47C9-A312-C117E55C924E/appyinxiangcom/17968037/ENResource/p1290)


需要注意的是：shared-configs指定的公共配置文件，本意是多个微服务共同使用，一般来说是不指定group的，也就是应当归⼊DEFAULT_GROUP这个公共分组。

`2、`修改bootstrap.properties文件配置
在需要使用公共配置的微服务中，修改其bootstrap.properties,增加如下配置即可：
```properties
spring.cloud.nacos.config.shared-configs[0].data-id=common-dev.properties
spring.cloud.nacos.config.shared-configs[0].group=DEFAULT_GROUP
spring.cloud.nacos.config.shared-configs[0].refresh=true
```

`3、在代码中获取配置中心的公共配置`
该怎么使用就怎么，和前面没有区别。


nacos管理配置文件 yml或properties都可以